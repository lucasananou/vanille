generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  CANCELLED
  REFUNDED
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(STAFF)
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

enum AddressType {
  SHIPPING
  BILLING
}

model Customer {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  emailVerified Boolean   @default(false)
  verificationToken String?
  resetToken    String?
  resetTokenExpiry DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  addresses     Address[]
  orders        Order[]
  carts         Cart[]
  reviews       Review[]
  wishlistItems WishlistItem[]
  segments      CustomerSegment[]
  
  @@map("customers")
}

model CustomerSegment {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  segmentType String   // VIP, AT_RISK, NEW, INACTIVE, LOYAL, etc.
  assignedAt  DateTime @default(now())
  
  @@unique([customerId, segmentType])
  @@map("customer_segments")
}

model Address {
  id          String      @id @default(cuid())
  customerId  String
  customer    Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  type        AddressType @default(SHIPPING)
  isDefault   Boolean     @default(false)
  
  firstName   String
  lastName    String
  company     String?
  address1    String
  address2    String?
  city        String
  province    String?
  postalCode  String
  country     String
  phone       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("addresses")
}

model Collection {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  image       String?
  published   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("collections")
}

model Product {
  id                  String            @id @default(cuid())
  title               String
  description         String?
  sku                 String            @unique
  slug                String            @unique
  price               Int
  compareAtPrice      Int?
  stock               Int               @default(0)
  images              String[]
  tags                String[]
  published           Boolean           @default(false)
  seoTitle            String?
  seoMetaDescription  String?
  collectionId        String?
  collection          Collection?       @relation(fields: [collectionId], references: [id])
  weight              Int?              // Grams
  dimensions          Json?             // { length, width, height }
  details             Json?             // { cut, material, modelInfo, advice }
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  cartItems           CartItem[]
  orderItems          OrderItem[]
  variants            ProductVariant[]
  options             ProductOption[]
  reviews             Review[]
  wishlistItems       WishlistItem[]

  @@map("products")
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

model Review {
  id              String       @id @default(cuid())
  productId       String
  product         Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  customerId      String?
  customer        Customer?    @relation(fields: [customerId], references: [id], onDelete: SetNull)
  orderId         String?      // For verified purchase
  
  rating          Int          // 1-5 stars
  title           String?
  comment         String
  
  status          ReviewStatus @default(PENDING)
  verifiedPurchase Boolean     @default(false)
  helpfulCount    Int          @default(0)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("reviews")
}

model WishlistItem {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  
  createdAt  DateTime @default(now())
  
  @@unique([customerId, productId, variantId])
  @@map("wishlist_items")
}

model ProductOption {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name      String   // "Size", "Color"
  values    String[] // ["S", "M", "L"] or ["Red", "Blue"]
  position  Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("product_options")
}

model ProductVariant {
  id              String     @id @default(cuid())
  productId       String
  product         Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  sku             String     @unique
  title           String     // "Small / Red"
  price           Int?       // Can override product price
  compareAtPrice  Int?
  stock           Int        @default(0)
  image           String?    // Variant-specific image
  
  options         Json       // { "size": "S", "color": "Red" }
  
  published       Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  cartItems       CartItem[]
  orderItems      OrderItem[]
  wishlistItems   WishlistItem[]
  
  @@map("product_variants")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

model DiscountCode {
  id                String       @id @default(cuid())
  code              String       @unique
  type              DiscountType
  value             Int          // Percentage (0-100) or fixed amount in cents
  
  minPurchase       Int?         // Minimum order amount
  maxUses           Int?         // Total uses allowed
  usedCount         Int          @default(0)
  maxUsesPerUser    Int?         @default(1)
  
  startsAt          DateTime?
  endsAt            DateTime?
  active            Boolean      @default(true)
  
  // Restrictions
  appliesToCollections String[]  // Collection IDs
  appliesToProducts    String[]  // Product IDs
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  orders            Order[]
  
  @@map("discount_codes")
}

model ShippingZone {
  id          String         @id @default(cuid())
  name        String
  countries   String[]       // ISO country codes
  regions     String[]       // State/province codes
  
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  rates       ShippingRate[]
  
  @@map("shipping_zones")
}

model ShippingRate {
  id              String       @id @default(cuid())
  zoneId          String
  zone            ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)
  
  name            String       // e.g., "Standard Shipping", "Express"
  price           Int          // Price in cents
  minOrderValue   Int?         // Min order for free/discounted shipping
  maxOrderValue   Int?         // Max order value eligible
  
  estimatedDays   String?      // e.g., "3-5 business days"
  active          Boolean      @default(true)
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  orders          Order[]
  
  @@map("shipping_rates")
}

model TaxRate {
  id          String   @id @default(cuid())
  country     String   // ISO country code
  region      String?  // State/province code
  
  rate        Float    // Tax rate as decimal (e.g., 0.2 for 20%)
  name        String   // e.g., "VAT", "Sales Tax"
  
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([country, region])
  @@map("tax_rates")
}

model Cart {
  id            String     @id @default(cuid())
  sessionId     String?    @unique
  userId        String?
  customerId    String?
  customer      Customer?  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items         CartItem[]
  lastUpdatedAt DateTime   @default(now())
  reminded      Boolean    @default(false)
  createdAt     DateTime   @default(now())

  @@map("carts")
}

model CartItem {
  id        String          @id @default(cuid())
  cartId    String
  cart      Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  quantity  Int             @default(1)
  price     Int
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([cartId, productId, variantId])
  @@map("cart_items")
}

model Order {
  id              String          @id @default(cuid())
  orderNumber     String          @unique
  email           String
  customerId      String?
  customer        Customer?       @relation(fields: [customerId], references: [id])
  discountCodeId  String?
  discountCode    DiscountCode?   @relation(fields: [discountCodeId], references: [id])
  shippingRateId  String?
  shippingRate    ShippingRate?   @relation(fields: [shippingRateId], references: [id])
  status          OrderStatus     @default(PENDING)
  subtotal        Int
  discountAmount  Int             @default(0)
  tax             Int             @default(0)
  shipping        Int             @default(0)
  total           Int
  shippingAddress Json?
  billingAddress  Json?
  items           OrderItem[]
  paymentIntents  PaymentIntent[]
  refunds         Refund[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@map("orders")
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

model Refund {
  id            String       @id @default(cuid())
  orderId       String
  order         Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  amount        Int          // Amount to refund in cents
  reason        String
  status        RefundStatus @default(PENDING)
  
  processedBy   String?      // Admin ID who processed it
  processedAt   DateTime?
  
  notes         String?      // Admin notes
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@map("refunds")
}

model OrderItem {
  id        String          @id @default(cuid())
  orderId   String
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  quantity  Int
  price     Int
  title     String
  image     String?
  createdAt DateTime        @default(now())

  @@map("order_items")
}

model PaymentIntent {
  id                    String   @id @default(cuid())
  orderId               String
  order                 Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  stripePaymentIntentId String   @unique
  amount                Int
  currency              String   @default("usd")
  status                String
  metadata              Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("payment_intents")
}