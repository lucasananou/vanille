<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0E1B14" />
  <title>Checkout — MSV Nosy-Be</title>
  <meta name="description"
    content="Finalisez votre commande MSV Nosy-Be : informations, livraison, paiement (UI prête à connecter) et récapitulatif." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
            display: ['Fraunces', 'ui-serif', 'Georgia', 'serif'],
          },
          colors: {
            obsidian: '#07100C',
            jungle: { 900: '#0E1B14' },
            vanilla: { 50: '#FBF7EF', 100: '#F6EEDC', 200: '#EEDDBD' },
            cacao: {
              950: '#120C0A', 900: '#1A1210', 800: '#2A1F1A',
              700: '#3C2E27', 600: '#5A514A', 500: '#6E625A'
            },
            gold: { 500: '#D7A84A', 600: '#C79637', 700: '#B6842B' }
          },
          boxShadow: {
            soft: '0 14px 40px rgba(7,16,12,.14)',
            lift: '0 22px 70px rgba(7,16,12,.20)',
            glow: '0 0 0 1px rgba(215,168,74,.18), 0 18px 60px rgba(215,168,74,.14)',
          },
          borderRadius: { xxl: '1.5rem' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>

  <style>
    .glass-dark {
      background: rgba(246, 238, 220, .06);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(246, 238, 220, .16);
    }

    .card-light {
      background: rgba(255, 255, 255, .78);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(26, 18, 16, .08);
    }

    .focus-ring:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(215, 168, 74, .35);
    }

    .grain::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image: radial-gradient(rgba(255, 255, 255, .06) 1px, transparent 1px);
      background-size: 3px 3px;
      opacity: .14;
      mix-blend-mode: overlay;
      pointer-events: none;
    }

    .hero {
      background:
        radial-gradient(1200px 420px at 18% 10%, rgba(215, 168, 74, .22), transparent 55%),
        radial-gradient(900px 420px at 80% 20%, rgba(246, 238, 220, .10), transparent 60%),
        linear-gradient(180deg, rgba(14, 27, 20, .96), rgba(14, 27, 20, .86));
    }

    .input {
      width: 100%;
      border-radius: 9999px;
      padding: .75rem 1rem;
      font-size: .875rem;
      background: #fff;
      border: 1px solid rgba(26, 18, 16, .10);
    }

    .input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(215, 168, 74, .25);
      border-color: rgba(215, 168, 74, .45);
    }

    @media (prefers-reduced-motion: reduce) {
      .rm-anim {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>

<body class="bg-vanilla-50 text-cacao-900 font-sans antialiased">
  <a href="#content"
    class="sr-only focus:not-sr-only focus:fixed focus:top-3 focus:left-3 focus:z-[100] focus:bg-white focus:text-cacao-900 focus:px-4 focus:py-2 focus:rounded-full">
    Aller au contenu
  </a>

  <!-- =========================
  HEADER (dark only)
  ========================== -->
  <header class="sticky top-0 z-50 border-b border-vanilla-100/15 bg-jungle-900/70 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-3">
      <a href="index.html" class="flex items-center gap-3 rounded-2xl px-2 py-1 focus-ring">
        <div
          class="w-10 h-10 rounded-2xl bg-vanilla-50/10 border border-vanilla-100/15 grid place-items-center shadow-soft">
          <span class="iconify text-gold-500 text-xl" data-icon="mdi:vanilla"></span>
        </div>
        <div class="leading-tight">
          <p class="font-display text-lg text-vanilla-50">MSV Nosy-Be</p>
          <p class="text-xs text-vanilla-100/70">Checkout</p>
        </div>
      </a>

      <nav class="hidden lg:flex items-center gap-1 text-sm text-vanilla-100/85" aria-label="Navigation principale">
        <a class="px-4 py-2 rounded-full hover:bg-vanilla-50/10 focus-ring" href="shop.html">Boutique</a>
        <a class="px-4 py-2 rounded-full hover:bg-vanilla-50/10 focus-ring" href="about.html">À propos</a>
        <a class="px-4 py-2 rounded-full hover:bg-vanilla-50/10 focus-ring" href="contact.html">Contact</a>
      </nav>

      <div class="flex items-center gap-2">
        <a href="cart.html"
          class="hidden sm:inline-flex items-center gap-2 rounded-full px-5 py-2.5 text-sm font-semibold text-jungle-900
                 bg-gradient-to-b from-gold-500 to-gold-600 shadow-glow hover:shadow-lift transition rm-anim focus-ring">
          Retour panier
          <span class="iconify" data-icon="mdi:arrow-right"></span>
        </a>
        <span
          class="inline-flex items-center gap-2 rounded-full px-3 py-2 text-xs font-semibold glass-dark text-vanilla-50">
          <span class="iconify text-gold-500" data-icon="mdi:lock-outline"></span>
          Paiement sécurisé <span class="text-vanilla-100/60">(à connecter)</span>
        </span>
      </div>
    </div>
  </header>

  <!-- =========================
  HERO (optional)
  ========================== -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 hero grain" aria-hidden="true"></div>
    <div class="relative mx-auto max-w-7xl px-4 py-9">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
        <div>
          <div class="inline-flex items-center gap-2 rounded-full glass-dark px-4 py-2 shadow-soft text-vanilla-50">
            <span class="iconify text-gold-500" data-icon="mdi:check-decagram-outline"></span>
            <span class="text-sm font-semibold">Finalisation</span>
            <span class="text-sm text-vanilla-100/70">• 2 minutes chrono</span>
          </div>
          <h1 class="mt-4 font-display text-3xl sm:text-4xl text-vanilla-50 leading-[1.06]">
            Checkout
          </h1>
          <p class="mt-3 text-sm text-vanilla-100/75 max-w-2xl">
            Renseignez vos informations, choisissez la livraison, puis validez le paiement.
            <span class="text-vanilla-100/60">Aucune promesse “livraison/retours” ici tant que ce n’est pas
              exact.</span>
          </p>
        </div>

        <div class="rounded-[22px] glass-dark p-4 w-full lg:w-[420px]">
          <p class="text-sm font-semibold text-vanilla-50">Récap rapide</p>
          <div class="mt-3 flex items-center justify-between text-sm">
            <span class="text-vanilla-100/70">Sous-total</span>
            <span class="font-semibold text-vanilla-50" id="heroSubtotal">0,00 €</span>
          </div>
          <p class="mt-2 text-xs text-vanilla-100/60">Livraison & taxes calculées selon adresse.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- =========================
  CHECKOUT (LIGHT)
  ========================== -->
  <main id="content" class="mx-auto max-w-7xl px-4 py-10">
    <div class="grid lg:grid-cols-12 gap-8 items-start">

      <!-- Left column -->
      <section class="lg:col-span-7 space-y-4">

        <!-- Contact -->
        <div class="rounded-[28px] card-light shadow-soft p-6">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-display text-2xl">Informations</h2>
            <span
              class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-semibold bg-vanilla-100 border border-cacao-900/10">
              <span class="iconify text-gold-600" data-icon="mdi:shield-check-outline"></span>
              Données protégées <span class="text-cacao-500">(à confirmer)</span>
            </span>
          </div>

          <div class="mt-5 grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-cacao-700" for="email">Email</label>
              <input class="input mt-2" id="email" type="email" placeholder="vous@exemple.com" autocomplete="email" />
            </div>
            <div>
              <label class="text-xs font-semibold text-cacao-700" for="phone">Téléphone</label>
              <input class="input mt-2" id="phone" type="tel" placeholder="+33…" autocomplete="tel" />
            </div>
          </div>

          <div class="mt-4 flex items-start gap-3">
            <input id="newsletter" type="checkbox" class="mt-1 h-4 w-4 rounded border border-cacao-900/20" />
            <label for="newsletter" class="text-sm text-cacao-700">
              Recevoir des conseils d’usage & recettes (optionnel).
            </label>
          </div>
        </div>

        <!-- Shipping address -->
        <div class="rounded-[28px] card-light shadow-soft p-6">
          <h2 class="font-display text-2xl">Adresse de livraison</h2>

          <div class="mt-5 grid sm:grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-semibold text-cacao-700" for="firstName">Prénom</label>
              <input class="input mt-2" id="firstName" type="text" placeholder="Prénom" autocomplete="given-name" />
            </div>
            <div>
              <label class="text-xs font-semibold text-cacao-700" for="lastName">Nom</label>
              <input class="input mt-2" id="lastName" type="text" placeholder="Nom" autocomplete="family-name" />
            </div>

            <div class="sm:col-span-2">
              <label class="text-xs font-semibold text-cacao-700" for="address1">Adresse</label>
              <input class="input mt-2" id="address1" type="text" placeholder="N° et rue"
                autocomplete="address-line1" />
            </div>
            <div class="sm:col-span-2">
              <label class="text-xs font-semibold text-cacao-700" for="address2">Complément (optionnel)</label>
              <input class="input mt-2" id="address2" type="text" placeholder="Bâtiment, étage, etc."
                autocomplete="address-line2" />
            </div>

            <div>
              <label class="text-xs font-semibold text-cacao-700" for="zip">Code postal</label>
              <input class="input mt-2" id="zip" type="text" placeholder="00000" autocomplete="postal-code" />
            </div>
            <div>
              <label class="text-xs font-semibold text-cacao-700" for="city">Ville</label>
              <input class="input mt-2" id="city" type="text" placeholder="Ville" autocomplete="address-level2" />
            </div>

            <div>
              <label class="text-xs font-semibold text-cacao-700" for="country">Pays</label>
              <select class="input mt-2" id="country" autocomplete="country">
                <option value="FR" selected>France</option>
                <option value="BE">Belgique</option>
                <option value="CH">Suisse</option>
                <option value="LU">Luxembourg</option>
                <option value="OTHER">Autre</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-semibold text-cacao-700" for="company">Entreprise (optionnel)</label>
              <input class="input mt-2" id="company" type="text" placeholder="Nom de société"
                autocomplete="organization" />
            </div>
          </div>

          <div class="mt-4 flex items-start gap-3">
            <input id="saveInfo" type="checkbox" class="mt-1 h-4 w-4 rounded border border-cacao-900/20" />
            <label for="saveInfo" class="text-sm text-cacao-700">
              Sauvegarder mes informations pour la prochaine fois (si compte / cookie).
            </label>
          </div>
        </div>

        <!-- Shipping method -->
        <div class="rounded-[28px] card-light shadow-soft p-6">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-display text-2xl">Livraison</h2>
            <span class="text-xs text-cacao-500">Tarifs calculés selon destination (à brancher)</span>
          </div>

          <div class="mt-5 space-y-3" role="radiogroup" aria-label="Choisir un mode de livraison">
            <label
              class="flex items-start gap-3 rounded-xxl bg-white/80 border border-cacao-900/10 p-4 hover:bg-white cursor-pointer">
              <input class="mt-1" type="radio" name="ship" value="standard" checked />
              <div class="flex-1">
                <div class="flex items-center justify-between gap-3">
                  <p class="font-semibold">Standard</p>
                  <p class="font-semibold" data-ship-price="standard">—</p>
                </div>
                <p class="mt-1 text-sm text-cacao-700">Délai estimé affiché au paiement (si dispo).</p>
              </div>
            </label>

            <label
              class="flex items-start gap-3 rounded-xxl bg-white/80 border border-cacao-900/10 p-4 hover:bg-white cursor-pointer">
              <input class="mt-1" type="radio" name="ship" value="express" />
              <div class="flex-1">
                <div class="flex items-center justify-between gap-3">
                  <p class="font-semibold">Express</p>
                  <p class="font-semibold" data-ship-price="express">—</p>
                </div>
                <p class="mt-1 text-sm text-cacao-700">Option premium si disponible.</p>
              </div>
            </label>
          </div>
        </div>

        <!-- Payment -->
        <div class="rounded-[28px] card-light shadow-soft p-6">
          <div class="flex items-center justify-between gap-3">
            <h2 class="font-display text-2xl">Paiement</h2>
            <span
              class="inline-flex items-center gap-2 rounded-full px-3 py-1.5 text-xs font-semibold bg-vanilla-100 border border-cacao-900/10">
              <span class="iconify text-gold-600" data-icon="mdi:lock-outline"></span>
              PCI / 3DS <span class="text-cacao-500">(à connecter)</span>
            </span>
          </div>

          <div class="mt-5 rounded-xxl bg-white/80 border border-cacao-900/10 p-4">
            <p class="text-sm text-cacao-700">
              UI prête à brancher (Stripe / autre). Pour l’instant, ce bouton simule la validation.
            </p>

            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <button
                class="inline-flex items-center justify-center gap-2 rounded-full px-4 py-2.5 text-sm font-semibold bg-white border border-cacao-900/10 hover:bg-vanilla-100 focus-ring">
                <span class="iconify text-cacao-700" data-icon="mdi:apple"></span> Apple Pay
              </button>
              <button
                class="inline-flex items-center justify-center gap-2 rounded-full px-4 py-2.5 text-sm font-semibold bg-white border border-cacao-900/10 hover:bg-vanilla-100 focus-ring">
                <span class="iconify text-cacao-700" data-icon="mdi:paypal"></span> PayPal
              </button>
            </div>

            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-semibold text-cacao-700" for="cardName">Nom sur la carte</label>
                <input class="input mt-2" id="cardName" type="text" placeholder="Nom complet" autocomplete="cc-name" />
              </div>
              <div>
                <label class="text-xs font-semibold text-cacao-700" for="cardNumber">Numéro</label>
                <input class="input mt-2" id="cardNumber" type="text" placeholder="•••• •••• •••• ••••"
                  inputmode="numeric" autocomplete="cc-number" />
              </div>
              <div>
                <label class="text-xs font-semibold text-cacao-700" for="cardExp">Expiration</label>
                <input class="input mt-2" id="cardExp" type="text" placeholder="MM/AA" inputmode="numeric"
                  autocomplete="cc-exp" />
              </div>
              <div>
                <label class="text-xs font-semibold text-cacao-700" for="cardCvc">CVC</label>
                <input class="input mt-2" id="cardCvc" type="text" placeholder="CVC" inputmode="numeric"
                  autocomplete="cc-csc" />
              </div>
            </div>

            <div class="mt-4 flex items-start gap-3">
              <input id="terms" type="checkbox" class="mt-1 h-4 w-4 rounded border border-cacao-900/20" />
              <label for="terms" class="text-sm text-cacao-700">
                J’accepte les <a href="legal.html"
                  class="underline underline-offset-4 font-semibold focus-ring rounded px-1">conditions</a> (à relier).
              </label>
            </div>
          </div>
        </div>

      </section>

      <!-- Right column: Summary -->
      <aside class="lg:col-span-5">
        <div class="lg:sticky lg:top-24 space-y-4">
          <div class="rounded-[28px] card-light shadow-lift p-6">
            <div class="flex items-center justify-between gap-3">
              <h3 class="font-display text-xl">Récapitulatif</h3>
              <button id="editCartBtn"
                class="text-sm font-semibold text-cacao-700 hover:text-cacao-900 underline underline-offset-4 focus-ring rounded-full px-2 py-1">
                Modifier
              </button>
            </div>

            <div id="emptyState" class="hidden mt-5 rounded-xxl bg-white/80 border border-cacao-900/10 p-5">
              <p class="font-semibold">Votre panier est vide.</p>
              <p class="mt-1 text-sm text-cacao-700">Retournez à la boutique pour sélectionner vos gousses.</p>
              <a href="shop.html"
                class="mt-4 inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 text-sm font-semibold text-jungle-900
                       bg-gradient-to-b from-gold-500 to-gold-600 shadow-glow hover:shadow-lift transition rm-anim focus-ring">
                Aller à la boutique
                <span class="iconify" data-icon="mdi:arrow-right"></span>
              </a>
            </div>

            <div id="summaryList" class="mt-5 space-y-3"></div>

            <div class="mt-5 rounded-xxl bg-white/80 border border-cacao-900/10 p-4">
              <div class="flex items-center justify-between text-sm">
                <span class="text-cacao-700">Sous-total</span>
                <span class="font-semibold" id="subtotal">0,00 €</span>
              </div>
              <div class="mt-2 flex items-center justify-between text-sm">
                <span class="text-cacao-700">Livraison</span>
                <span class="font-semibold" id="shipping">—</span>
              </div>
              <div class="mt-2 flex items-center justify-between text-sm">
                <span class="text-cacao-700">Taxes</span>
                <span class="font-semibold" id="taxes">—</span>
              </div>

              <div class="mt-4 pt-4 border-t border-cacao-900/10 flex items-center justify-between">
                <span class="text-cacao-900 font-semibold">Total</span>
                <span class="text-xl font-semibold" id="total">0,00 €</span>
              </div>
            </div>

            <button id="payBtn"
              class="mt-5 w-full inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 text-sm font-semibold text-jungle-900
                     bg-gradient-to-b from-gold-500 to-gold-600 shadow-glow hover:shadow-lift transition rm-anim focus-ring">
              Valider & payer
              <span class="iconify" data-icon="mdi:lock-outline"></span>
            </button>
            <p class="mt-2 text-xs text-cacao-600">
              Vous recevrez une confirmation par email. <span class="text-cacao-500">(workflow à connecter)</span>
            </p>

            <!-- Trust -->
            <div class="mt-5 grid grid-cols-3 gap-3 text-xs">
              <div class="rounded-xxl bg-white/80 border border-cacao-900/10 p-3 text-center">
                <span class="iconify text-gold-600 text-xl" data-icon="mdi:shield-check-outline"></span>
                <p class="mt-1 font-semibold">Sécurisé</p>
                <p class="text-cacao-500">à confirmer</p>
              </div>
              <div class="rounded-xxl bg-white/80 border border-cacao-900/10 p-3 text-center">
                <span class="iconify text-gold-600 text-xl" data-icon="mdi:truck-outline"></span>
                <p class="mt-1 font-semibold">Livraison</p>
                <p class="text-cacao-500">à préciser</p>
              </div>
              <div class="rounded-xxl bg-white/80 border border-cacao-900/10 p-3 text-center">
                <span class="iconify text-gold-600 text-xl" data-icon="mdi:chat-outline"></span>
                <p class="mt-1 font-semibold">Support</p>
                <p class="text-cacao-500">contact</p>
              </div>
            </div>
          </div>

          <div class="rounded-[28px] bg-white/70 border border-cacao-900/10 p-5">
            <p class="text-sm font-semibold">Anti-abandon (senior e-com)</p>
            <ul class="mt-3 space-y-2 text-sm text-cacao-700">
              <li class="flex gap-2"><span class="iconify text-gold-600 mt-0.5"
                  data-icon="mdi:check-circle-outline"></span> Formulaire clair, une colonne, zéro friction.</li>
              <li class="flex gap-2"><span class="iconify text-gold-600 mt-0.5"
                  data-icon="mdi:check-circle-outline"></span> Total toujours visible (sticky).</li>
              <li class="flex gap-2"><span class="iconify text-gold-600 mt-0.5"
                  data-icon="mdi:check-circle-outline"></span> “Modifier panier” accessible sans perdre l’étape.</li>
            </ul>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <!-- Mobile sticky CTA -->
  <div class="lg:hidden fixed bottom-0 left-0 right-0 z-40 bg-white/85 backdrop-blur border-t border-cacao-900/10">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-3">
      <div>
        <p class="text-xs text-cacao-600">Total</p>
        <p class="text-base font-semibold" id="mobileTotal">0,00 €</p>
      </div>
      <button id="mobilePayBtn" class="inline-flex items-center justify-center gap-2 rounded-full px-5 py-3 text-sm font-semibold text-jungle-900
               bg-gradient-to-b from-gold-500 to-gold-600 shadow-glow focus-ring">
        Payer
        <span class="iconify" data-icon="mdi:lock-outline"></span>
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed bottom-20 left-1/2 -translate-x-1/2 z-[60] hidden">
    <div class="rounded-full bg-cacao-900 text-white px-4 py-3 shadow-lift flex items-center gap-2">
      <span class="iconify text-gold-500 text-xl" data-icon="mdi:information-outline"></span>
      <p class="text-sm font-semibold" id="toastText">—</p>
    </div>
  </div>

  <script>
    // =========================
    // CART (compatible)
    // =========================
    const CART_KEYS = ["msv_cart", "cart"];
    const fmt = new Intl.NumberFormat("fr-FR", { style: "currency", currency: "EUR" });
    const $ = (id) => document.getElementById(id);

    function safeParse(v, fb) { try { return JSON.parse(v); } catch { return fb; } }
    function resolveCartKey() { for (const k of CART_KEYS) if (localStorage.getItem(k)) return k; return CART_KEYS[0]; }
    const CART_KEY = resolveCartKey();

    function normalize(raw) {
      if (!raw) return [];
      if (Array.isArray(raw)) return raw;
      if (Array.isArray(raw.items)) return raw.items;
      if (Array.isArray(raw.cart)) return raw.cart;
      if (Array.isArray(raw.products)) return raw.products;
      return [];
    }
    function getCart() {
      const raw = safeParse(localStorage.getItem(CART_KEY), null);
      return normalize(raw).map(it => ({
        id: it.id ?? it.sku ?? it.slug ?? String(Math.random()),
        name: it.name ?? it.title ?? "Produit",
        price: Number(it.price ?? it.unitPrice ?? 0),
        qty: Math.max(1, Number(it.qty ?? it.quantity ?? 1)),
        image: it.image ?? it.img ?? it.thumbnail ?? ""
      }));
    }
    function cartSubtotal(items) { return items.reduce((s, it) => s + (it.price * it.qty), 0); }
    function esc(str) {
      return String(str).replace(/[&<>"']/g, s => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[s]));
    }

    // =========================
    // Shipping calculator (UI)
    // (Pas de promesses : valeurs indicatives configurables)
    // =========================
    const SHIPPING = {
      standard: 0, // mets 0 si tu veux afficher "—" par défaut
      express: 0
    };
    const TAXES_RATE = 0; // ex: 0.20 si tu veux simuler une TVA, sinon 0

    // =========================
    // Toast
    // =========================
    const toastEl = $("toast");
    const toastText = $("toastText");
    let toastTimer = null;
    function toast(msg) {
      toastText.textContent = msg;
      toastEl.classList.remove("hidden");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.add("hidden"), 1700);
    }

    // =========================
    // Render summary
    // =========================
    const summaryList = $("summaryList");
    const emptyState = $("emptyState");

    const subtotalEl = $("subtotal");
    const shippingEl = $("shipping");
    const taxesEl = $("taxes");
    const totalEl = $("total");

    const heroSubtotal = $("heroSubtotal");
    const mobileTotal = $("mobileTotal");

    const shipPriceEls = document.querySelectorAll("[data-ship-price]");

    function getSelectedShip() {
      const el = document.querySelector('input[name="ship"]:checked');
      return el ? el.value : "standard";
    }

    function computeTotals() {
      const items = getCart();
      const sub = cartSubtotal(items);
      const shipKey = getSelectedShip();
      const ship = Number(SHIPPING[shipKey] || 0);
      const taxes = Math.max(0, sub * Number(TAXES_RATE || 0));
      const total = sub + ship + taxes;
      return { items, sub, ship, taxes, total, shipKey };
    }

    function render() {
      const { items, sub, ship, taxes, total, shipKey } = computeTotals();

      heroSubtotal.textContent = fmt.format(sub || 0);

      const empty = items.length === 0;
      emptyState.classList.toggle("hidden", !empty);
      summaryList.classList.toggle("hidden", empty);

      if (empty) {
        summaryList.innerHTML = "";
        subtotalEl.textContent = fmt.format(0);
        shippingEl.textContent = "—";
        taxesEl.textContent = "—";
        totalEl.textContent = fmt.format(0);
        mobileTotal.textContent = fmt.format(0);
        shipPriceEls.forEach(el => el.textContent = "—");
        return;
      }

      summaryList.innerHTML = items.map(it => `
        <div class="rounded-xxl bg-white/80 border border-cacao-900/10 p-4">
          <div class="flex items-start gap-3">
            <div class="w-14 h-14 rounded-2xl bg-white border border-cacao-900/10 overflow-hidden grid place-items-center flex-shrink-0">
              ${it.image ? `<img src="${it.image}" alt="${esc(it.name)}" class="w-full h-full object-cover" onerror="this.remove(); this.parentElement.innerHTML='<span class=&quot;iconify text-gold-600 text-2xl&quot; data-icon=&quot;mdi:vanilla&quot;></span>';">`
          : `<span class="iconify text-gold-600 text-2xl" data-icon="mdi:vanilla"></span>`}
            </div>
            <div class="min-w-0 flex-1">
              <p class="font-semibold text-cacao-900 truncate">${esc(it.name)}</p>
              <p class="mt-1 text-sm text-cacao-700">${it.qty} × ${fmt.format(it.price || 0)}</p>
            </div>
            <p class="font-semibold">${fmt.format((it.price || 0) * (it.qty || 0))}</p>
          </div>
        </div>
      `).join("");

      subtotalEl.textContent = fmt.format(sub || 0);
      shippingEl.textContent = ship > 0 ? fmt.format(ship) : "Calculée selon adresse";
      taxesEl.textContent = taxes > 0 ? fmt.format(taxes) : "Selon destination";
      totalEl.textContent = fmt.format(total || 0);
      mobileTotal.textContent = fmt.format(total || 0);

      shipPriceEls.forEach(el => {
        const key = el.getAttribute("data-ship-price");
        const v = Number(SHIPPING[key] || 0);
        el.textContent = v > 0 ? fmt.format(v) : "—";
      });
    }

    // =========================
    // Actions
    // =========================
    $("editCartBtn").addEventListener("click", () => window.location.href = "cart.html");

    document.querySelectorAll('input[name="ship"]').forEach(r => {
      r.addEventListener("change", render);
    });

    function validateBeforePay() {
      const items = getCart();
      if (!items.length) { toast("Panier vide — retour boutique"); return false; }

      const email = ($("email").value || "").trim();
      const firstName = ($("firstName").value || "").trim();
      const lastName = ($("lastName").value || "").trim();
      const address1 = ($("address1").value || "").trim();
      const zip = ($("zip").value || "").trim();
      const city = ($("city").value || "").trim();

      if (!email || !firstName || !lastName || !address1 || !zip || !city) {
        toast("Veuillez compléter les champs obligatoires (email + adresse).");
        return false;
      }
      if (!$("terms").checked) {
        toast("Veuillez accepter les conditions.");
        return false;
      }
      return true;
    }

    function pay() {
      if (!validateBeforePay()) return;
      toast("Paiement non connecté — branche Stripe ici.");
      // Ici tu branches Stripe Checkout / Payment Element, puis redirect success/cancel
      // window.location.href = "success.html";
    }

    $("payBtn").addEventListener("click", pay);
    $("mobilePayBtn").addEventListener("click", pay);

    window.addEventListener("storage", (e) => { if (CART_KEYS.includes(e.key)) render(); });

    // Boot
    render();
  </script>
</body>

</html>